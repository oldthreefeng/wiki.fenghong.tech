---
title: "ULB负载均衡踩的坑"
date: 2018-12-18 12:22
tag: http
---

[TOC]

## ULB的http强转https

负载均衡是高可用网络基础架构的关键组件，通常用于将工作负载分布到多个服务器来提高网站、应用、数据库或其他服务的性能和可靠性。

负载均衡（ULB）能够为多个主机或其它服务实例提供基于网络报文或代理方式的流量分发的功能。用于在高并发服务环境下，构建由多个服务节点组成的“负载均衡服务集群”。“服务集群”能够扩展服务的处理及容错能力，并可自动消除由于单一服务节点故障对服务整体的影响，提高服务的可用性。

目前ULB针对七层支持HTTP、HTTPs协议（类Nginx或HAproxy）；针对四层支持TCP协议及UDP协议（类LVS）。并且TCP协议支持两种方式：报文转发与请求代理。报文转发与请求代理模式详情可参考[TCP的请求代理与报文转发](https://docs.ucloud.cn/network/ulb/intro#tcp%E7%9A%84%E8%AF%B7%E6%B1%82%E4%BB%A3%E7%90%86%E4%B8%8E%E6%8A%A5%E6%96%87%E8%BD%AC%E5%8F%91)。四层ULB支持外网与内网两种模式，而七层ULB目前仅支持外网。您可以参考[如何选择ULB](https://docs.ucloud.cn/network/ulb/common#%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9ulb)选择哪一层ULB来部署业务。

忙活了几天，对ulb的负载均衡总算是有点成果了。如下：

## 配置相关


第一步：前段负载均衡器的配置

1. 创建负载均衡器。
   进入ucloud的官网，加入开启一台ulb负载均衡器。这里对外开放，我们选择的是公网绑定

2. 创建VServer，和阿里云一样，创建两个VServer一个是80端口，一个是443端口。

3. 用到443端口意味着我们需要上传ssl证书，上传也比较简单，上传申请的证书的crt和key文件即可。
4. http强制跳转至https，ulb暂未开通此项服务，只能在后端的服务器上添加转发规则。

第二步：后端服务器配置

1.   安装nginx ，这里就不多累述，前面已经写过。
[nginx编译安装](https://www.tapd.cn/23280401/markdown_wikis/view/#1123280401001000871@toc2)

2.   配置nginx

```
vim /etc/nginx/conf.d/test.conf
server {
       listen       81;
       server_name  www.fenghong.tech;
       location / {
          	proxy_pass http://localhost:8080;
          	proxy_set_header       Host $host;
          	proxy_set_header  X-Real-IP  $remote_addr;
          	proxy_set_header  X-Forwarded-For$proxy_add_x_forwarded_for;
       }
        location = /50x.html {
           	root   html;
       }
}
server {
       listen       80;
       server_name  www.fenghong.tech;
       #实现http到https强转的问题
       rewrite ^(.*)$  https://www.fenghong.tech$1 permanent;
       location / {
        	proxy_pass http://localhost:8080;
       }
       location = /50x.html {
          	root   html;
       }
}
```

## 踩过的坑

1. 配置后端的ssl证书且监听在443端口，导致网站被无限重定向，报错如下：

```
www2.fenghong.tech 将您重定向的次数过多。
尝试清除 Cookie.
ERR_TOO_MANY_REDIRECTS
```
2. 504网关错误
由于nginx的每个`server`段的`location`里均有对ip的访问控制，取消限制或者加入白名单即可:

![504](/images/1545102659373.png?raw=true)


3. 后端配置443端口证书且配置80端口，并且不配置重定向http-->https。出现以下400报错:


```
400 Bad Request
The plain HTTP request was sent to HTTPS port
```
4. 最多的一次错误即403权限拒绝，公司内部的权限控制很多，缺少对这方面的敏锐性

首先在`nginx.conf`的主配置文件里面对ip有访问控制。

```
	allow  10.9.0.0/16;
	deny    all; 
```
其次在`test.conf`的主机配置文件里面，对ip有访问控制。
在其次在[知道创宇](https://www.yunaq.com)的域名访问里面，对ip有限制。
多重的权限设置是这次负载均衡踩坑的关键点。

```
403 forbidden
```